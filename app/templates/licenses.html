{% extends "base.html" %}
{% block content %}
<section class="page-head">
  <div>
    <h1>Licenses</h1>
    <p>Create and manage access keys for the app.</p>
  </div>
</section>
{% if marzban_message %}
<div class="notice {% if marzban_status == 'ok' %}notice-success{% else %}notice-error{% endif %}">
  {{ marzban_message }}
</div>
{% endif %}

<section class="card form-card">
  <div class="card-head">
    <h2>Create License</h2>
  </div>
  <form class="form-grid" method="post" action="/licenses/new">
    <label>
      <span>Max Devices</span>
      <input type="number" name="max_devices" min="1" value="1" />
    </label>
    <label>
      <span>User Login (optional)</span>
      <input type="text" name="marzban_username" placeholder="user123" />
    </label>
    <label>
      <span>Group</span>
      <select name="group_name">
        {% for group in groups %}
        <option value="{{ group.name }}" {% if group.name == default_group %}selected{% endif %}>
          {{ group.name }}
        </option>
        {% endfor %}
      </select>
    </label>
    <label class="span-2">
      <span>Note</span>
      <input type="text" name="note" placeholder="VIP customer" />
    </label>
    <div class="form-actions">
      <button type="submit">Generate</button>
    </div>
  </form>
</section>

<section class="card form-card">
  <div class="card-head">
    <h2>Migrate Marzban User</h2>
  </div>
  <form class="form-grid" method="post" action="/licenses/migrate">
    <label>
      <span>Marzban Username</span>
      <input type="text" name="marzban_username" placeholder="user123" />
    </label>
    <label>
      <span>Group</span>
      <select name="group_name">
        {% for group in groups %}
        <option value="{{ group.name }}" {% if group.name == default_group %}selected{% endif %}>
          {{ group.name }}
        </option>
        {% endfor %}
      </select>
    </label>
    <label class="span-2">
      <span>Note</span>
      <input type="text" name="note" placeholder="Migration from Marzban" />
    </label>
    <div class="form-actions">
      <button type="submit">Create License</button>
    </div>
  </form>
</section>

<section class="card table-card">
  <div class="card-head">
    <h2>All Licenses</h2>
    <form class="search" method="get" action="/licenses">
      <input type="text" name="q" placeholder="Search code, user, group" value="{{ query }}" />
      <button type="submit">Search</button>
    </form>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Status</th>
          <th>Devices</th>
          <th>Max</th>
          <th>User</th>
          <th>Group</th>
          <th>Last Used</th>
          <th>Note</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for license in licenses %}
        <tr>
          <td class="mono">{{ license.code }}</td>
          <td>
            <span class="status {{ license.status }}">{{ license.status }}</span>
          </td>
          <td class="num">{{ license.device_count }}</td>
          <td class="num">{{ license.max_devices }}</td>
          <td>{{ license.marzban_username or '-' }}</td>
          <td>{{ license.group_name or '-' }}</td>
          <td>{{ license.last_used_at or '-' }}</td>
          <td>{{ license.note or '-' }}</td>
          <td>
            <div class="action-group">
              <a class="ghost-link" href="/licenses/{{ license.code }}">Manage</a>
              <form method="post" action="/licenses/{{ license.code }}/toggle">
                <button type="submit" class="ghost">
                  {% if license.status == 'active' %}Disable{% else %}Activate{% endif %}
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
