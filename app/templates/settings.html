{% extends "base.html" %}
{% block content %}
<section class="page-head">
  <div>
    <h1>Settings</h1>
    <p>Configure Marzban access and app defaults.</p>
  </div>
</section>

<section class="card form-card">
  <div class="card-head">
    <h2>Marzban Connection</h2>
    {% if marzban_status == "ok" %}
    <span class="status active">Connected</span>
    {% elif marzban_status == "fail" %}
    <span class="status disabled">Failed</span>
    {% else %}
    <span class="status pending">Not tested</span>
    {% endif %}
  </div>
  {% if marzban_message %}
  <div class="notice {% if marzban_status == 'ok' %}notice-success{% else %}notice-error{% endif %}">
    {{ marzban_message }}
  </div>
  {% endif %}
  <form class="form-grid compact" method="post" action="/settings/marzban/test">
    <div class="form-note span-2">
      Uses <span class="mono">/api/admin/token</span> with the saved Marzban username and password.
    </div>
    <div class="form-note span-2">
      Current base URL: <span class="mono">{{ settings.get("marzban_base_url") or "not set" }}</span>
    </div>
    <div class="form-actions">
      <button type="submit">Test Marzban API</button>
    </div>
  </form>
  {% if marzban_inbounds %}
  <form class="form-grid inbound-grid" method="post" action="/settings/inbounds">
    <div class="inbound-list span-2">
      {% for inbound in marzban_inbounds %}
      <label class="inbound-item">
        <input
          type="checkbox"
          name="allowed_inbounds"
          value="{{ inbound.tag }}"
          {% if inbound.tag in allowed_inbounds %}checked{% endif %}
        />
        <div>
          <div class="inbound-title">{{ inbound.tag }}</div>
          <div class="inbound-meta">
            {{ inbound.protocol|upper }} · {{ inbound.network }} · {{ inbound.tls }} · {{ inbound.port }}
          </div>
        </div>
      </label>
      {% endfor %}
    </div>
    <div class="form-actions">
      <button type="submit">Save Allowed Inbounds</button>
    </div>
  </form>
  {% else %}
  <div class="form-note">Run the test above to load inbound tags from Marzban.</div>
  {% endif %}
</section>

<section class="card form-card">
  <div class="card-head">
    <h2>Core Settings</h2>
  </div>
  <form class="form-grid" method="post" action="/settings">
    {% for field in fields %}
    {% if field.key != "allowed_inbounds" %}
    <label class="span-2">
      <span>{{ field.label }}</span>
      <input
        type="{{ field.type }}"
        name="{{ field.key }}"
        value="{{ settings.get(field.key, '') }}"
        placeholder=""
      />
    </label>
    {% endif %}
    {% endfor %}
    <div class="form-actions">
      <button type="submit">Save Settings</button>
    </div>
  </form>
</section>
{% endblock %}
