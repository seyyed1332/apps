{% extends "base.html" %}
{% block content %}
<section class="page-head">
  <div>
    <h1>Settings</h1>
    <p>Configure Marzban access and app defaults.</p>
  </div>
</section>

<section class="card form-card">
  <div class="card-head">
    <h2>Marzban Connection</h2>
    {% if marzban_status == "ok" %}
    <span class="status active">Connected</span>
    {% elif marzban_status == "fail" %}
    <span class="status disabled">Failed</span>
    {% else %}
    <span class="status pending">Not tested</span>
    {% endif %}
  </div>
  {% if marzban_message %}
  <div class="notice {% if marzban_status == 'ok' %}notice-success{% else %}notice-error{% endif %}">
    {{ marzban_message }}
  </div>
  {% endif %}
  <form class="form-grid compact" method="post" action="/settings/marzban/test">
    <div class="form-note span-2">
      Uses <span class="mono">/api/admin/token</span> with the saved Marzban username and password.
    </div>
    <div class="form-note span-2">
      Current base URL: <span class="mono">{{ settings.get("marzban_base_url") or "not set" }}</span>
    </div>
    <div class="form-actions">
      <button type="submit">Test Marzban API</button>
    </div>
  </form>
  <div class="form-note">Run the test above to load inbound tags from Marzban.</div>
</section>

<section class="card form-card">
  <div class="card-head centered">
    <h2>Groups</h2>
    <span class="status pending">Default: {{ default_group }}</span>
  </div>
  <form class="form-grid compact centered" method="post" action="/groups/new">
    <label class="span-2">
      <span>New group name</span>
      <input type="text" name="group_name" placeholder="free" />
    </label>
    <div class="form-actions">
      <button type="submit">Create Group</button>
    </div>
  </form>

  {% if marzban_inbounds and groups %}
  <div class="group-tabs" data-group-tabs>
    {% for group in groups %}
    <button type="button" class="group-tab{% if loop.first %} active{% endif %}" data-group-tab="{{ group.name }}">
      {{ group.name }}
    </button>
    {% endfor %}
  </div>

  {% for group in groups %}
  <div class="group-panel{% if not loop.first %} hidden{% endif %}" data-group-panel="{{ group.name }}">
    <div class="group-meta">
      <div class="group-title">{{ group.name }}</div>
      <form method="post" action="/groups/{{ group.name }}/default">
        <button type="submit" class="ghost">Set Default</button>
      </form>
    </div>
    <form class="form-grid inbound-grid" method="post" action="/groups/{{ group.name }}/inbounds">
      <div class="inbound-row span-2">
        {% for inbound in marzban_inbounds %}
        <label class="inbound-pill">
          <input
            type="checkbox"
            name="allowed_inbounds"
            value="{{ inbound.tag }}"
            {% if inbound.tag in group_allowed.get(group.name, []) %}checked{% endif %}
          />
          <span>
            {{ inbound.tag }} ({{ inbound.protocol|upper }} / {{ inbound.network }} / {{ inbound.tls }} / {{ inbound.port }})
          </span>
        </label>
        {% endfor %}
      </div>
      <div class="form-actions">
        <button type="submit">Save Inbounds</button>
      </div>
    </form>
  </div>
  {% endfor %}
  {% else %}
  <div class="form-note">Run the test above to load inbound tags from Marzban.</div>
  {% endif %}
</section>

<section class="card form-card">
  <div class="card-head">
    <h2>App Features</h2>
  </div>
  <form class="form-grid" method="post" action="/settings/features">
    <label class="checkbox span-2">
      <input type="checkbox" name="allow_free_signup" {% if allow_free_signup %}checked{% endif %} />
      <span>Allow free account signup</span>
    </label>
    <div class="form-actions">
      <button type="submit">Save Features</button>
    </div>
  </form>
</section>

<section class="card form-card">
  <div class="card-head">
    <h2>App Updates</h2>
  </div>
  <form class="form-grid" method="post" action="/settings/updates">
    <label class="checkbox span-2">
      <input type="checkbox" name="update_enabled" {% if update_enabled %}checked{% endif %} />
      <span>Enable update checks</span>
    </label>
    <label class="checkbox span-2">
      <input type="checkbox" name="update_mandatory" {% if update_mandatory %}checked{% endif %} />
      <span>Force update (block app until updated)</span>
    </label>
    {% for field in update_fields %}
    <label class="span-2">
      <span>{{ field.label }}</span>
      <input
        type="{{ field.type }}"
        name="{{ field.key }}"
        value="{{ settings.get(field.key, '') }}"
        placeholder=""
      />
    </label>
    {% endfor %}
    <div class="form-actions">
      <button type="submit">Save Updates</button>
    </div>
  </form>
</section>

<section class="card form-card">
  <div class="card-head">
    <h2>Core Settings</h2>
  </div>
  <form class="form-grid" method="post" action="/settings">
    {% for field in fields %}
    {% if field.key != "allowed_inbounds" %}
    <label class="span-2">
      <span>{{ field.label }}</span>
      <input
        type="{{ field.type }}"
        name="{{ field.key }}"
        value="{{ settings.get(field.key, '') }}"
        placeholder=""
      />
    </label>
    {% endif %}
    {% endfor %}
    <div class="form-actions">
      <button type="submit">Save Settings</button>
    </div>
  </form>
</section>
{% endblock %}
